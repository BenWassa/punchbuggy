(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}})();(function(e){function t(i){return!i||typeof i!="object"||(i.players=i.players||{},i.players.A=i.players.A||{name:"Player A",score:0,streak:0,avatar:""},i.players.B=i.players.B||{name:"Player B",score:0,streak:0,avatar:""},["A","B"].forEach(r=>{const s=i.players[r]||{};typeof s.score!="number"&&(s.score=Number(s.score)||0),typeof s.streak!="number"&&(s.streak=Number(s.streak)||0),typeof s.avatar!="string"&&(s.avatar=s.avatar||""),i.players[r]=s}),Array.isArray(i.roundWinners)?i.roundWinners=i.roundWinners.map(r=>r?typeof r=="string"?r==="A"?{winner:"A",scoreA:0,scoreB:0}:r==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:r:null).filter(Boolean):i.roundWinners=i.roundWinners||[],i.round=i.round||1,i.history=Array.isArray(i.history)?i.history:i.history?[i.history]:[],i.schemaVersion="2.0.0"),i}function a(){try{const i=localStorage.getItem("punchBuggy");if(!i)return{migrated:!1,reason:"no-state"};let r=null;try{r=JSON.parse(i)}catch(c){return{migrated:!1,reason:"invalid-json",error:c}}if(r&&r.schemaVersion==="2.0.0")return{migrated:!1,reason:"already-v2"};const s=t(r);return localStorage.setItem("punchBuggy",JSON.stringify(s)),{migrated:!0,nextState:s}}catch(i){return console.error("Migration failed",i),{migrated:!1,reason:"exception",error:i}}}e.PunchBuggyMigrations=e.PunchBuggyMigrations||{},e.PunchBuggyMigrations.migrateIfNeeded=a})(window);const n=e=>document.querySelector(e),o={round:1,players:{A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},roundWinners:[],history:[],undoStack:[]},$=n("#appVersion");if($){const e=localStorage.getItem("punchBuggy_running_version"),t=window.PUNCHBUGGY_APP_VERSION||"unknown",a=e||t;$.textContent=a,(!e||e!==t)&&(localStorage.setItem("punchBuggy_running_version",t),$.textContent=t)}console.log("[PunchBuggy] Version info:",{runningVersion:localStorage.getItem("punchBuggy_running_version"),fetchedVersion:window.PUNCHBUGGY_APP_VERSION,autoApplyEnabled:window.PUNCHBUGGY_AUTO_APPLY_UPDATES});function p(){n("#scoreA").textContent=o.players.A.score,n("#scoreB").textContent=o.players.B.score,I(n("#streakA"),o.players.A.streak),I(n("#streakB"),o.players.B.streak),n("#nameA").value=o.players.A.name,n("#nameB").value=o.players.B.name,o.players.A.avatar&&(n("#avatarA").src=o.players.A.avatar),o.players.B.avatar&&(n("#avatarB").src=o.players.B.avatar),n("#round").textContent=o.round;const e=o.players.A.score-o.players.B.score;n("#lead").textContent=e===0?"Tied":e>0?`${o.players.A.name} +${e}`:`${o.players.B.name} +${Math.abs(e)}`,R();const t=o.players.A.score===o.players.B.score?null:o.players.A.score>o.players.B.score?"A":"B";t==="A"?(n("#crownA").style.display="flex",n("#crownB").style.display="none"):t==="B"?(n("#crownB").style.display="flex",n("#crownA").style.display="none"):(n("#crownA").style.display="none",n("#crownB").style.display="none"),M(),j()}const V=["smolder","burning","inferno"];function I(e,t){e&&(e.classList.remove(...V),e.innerHTML=`<span class="fire-icon">ðŸ”¥</span> ${t} Streak`,t>=10?e.classList.add("inferno"):t>=5?e.classList.add("burning"):t>=3&&e.classList.add("smolder"))}function M(){const e=n("#modalLog");e&&(e.innerHTML=o.history.slice().reverse().map(t=>`<li style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)">${t}</li>`).join(""))}function R(){const e=o.roundWinners.map(l=>l?typeof l=="string"?l==="A"?{winner:"A",scoreA:0,scoreB:0}:l==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:l:null).filter(Boolean),t=n("#miniList");t.innerHTML="",e.forEach((l,x)=>{const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="space-between",d.style.gap="12px",d.style.padding="8px",d.style.borderRadius="10px",d.style.background="linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))";const y=document.createElement("div");y.style.display="flex",y.style.alignItems="center",y.style.gap="10px";const A=document.createElement("div");A.className="token",A.textContent=x+1,A.style.width="34px",A.style.height="34px",A.style.fontSize="14px";const b=document.createElement("div");b.style.fontWeight="700",b.textContent=l.winner==="T"?"Tie":l.winner==="A"?o.players.A.name:o.players.B.name,y.appendChild(A),y.appendChild(b);const B=document.createElement("div");B.style.fontWeight="800",B.textContent=`${l.scoreA} â€” ${l.scoreB}`,l.winner==="A"?d.style.borderLeft="4px solid rgba(93,212,162,0.9)":l.winner==="B"&&(d.style.borderLeft="4px solid rgba(138,168,255,0.9)"),t.appendChild(d),d.appendChild(y),d.appendChild(B)});let a=0,i=0,r=0,s=0,c=0;e.forEach(l=>{a+=l.scoreA,i+=l.scoreB,l.winner==="A"?r++:l.winner==="B"?s++:c++});const g=a+i,h=r+s,m=h?Math.round(r/h*100):50,P=100-m,u=o.players.A.avatar||n("#avatarA").src,f=o.players.B.avatar||n("#avatarB").src;n("#lbAvatarA")&&(n("#lbAvatarA").src=u),n("#lbAvatarB")&&(n("#lbAvatarB").src=f),n("#lbNameA")&&(n("#lbNameA").textContent=o.players.A.name),n("#lbNameB")&&(n("#lbNameB").textContent=o.players.B.name),n("#lbWinsA")&&(n("#lbWinsA").textContent=r),n("#lbWinsB")&&(n("#lbWinsB").textContent=s),n("#lbPercentA")&&(n("#lbPercentA").textContent=`${m}%`),n("#lbPercentB")&&(n("#lbPercentB").textContent=`${P}%`),n("#lbMeterA")&&(n("#lbMeterA").style.width=`${m}%`),n("#lbMeterB")&&(n("#lbMeterB").style.width=`${P}%`),n("#lbTotalRounds")&&(n("#lbTotalRounds").textContent=e.length),n("#lbTotalTies")&&(n("#lbTotalTies").textContent=c),n("#lbTotalPunches")&&(n("#lbTotalPunches").textContent=g),n("#lbHistoryCount")&&(n("#lbHistoryCount").textContent=e.length);const _=n("#lbPlayerA"),O=n("#lbPlayerB");_&&_.classList.toggle("winner",r>s),O&&O.classList.toggle("winner",s>r),n("#lbCrownA")&&(n("#lbCrownA").style.display=r>s?"block":"none"),n("#lbCrownB")&&(n("#lbCrownB").style.display=s>r?"block":"none");const C=n("#roundList");C&&(C.innerHTML="",e.slice().reverse().forEach((l,x)=>{const d=e.length-x,y=document.createElement("div"),A=l.winner==="A"?"win-a":l.winner==="B"?"win-b":"tie";y.className=`round-item ${A}`;const b=document.createElement("div");b.className="round-num",b.textContent=`#${d}`;const B=document.createElement("div");B.className="round-scores";const S=document.createElement("span");S.className=`score-val p1 ${l.scoreA>l.scoreB?"winner":"dim"}`,S.textContent=l.scoreA;const L=document.createElement("span");L.className="round-divider",L.textContent="â€”";const T=document.createElement("span");T.className=`score-val p2 ${l.scoreB>l.scoreA?"winner":"dim"}`,T.textContent=l.scoreB,B.appendChild(S),B.appendChild(L),B.appendChild(T);const E=document.createElement("div");E.className="round-badge";const U=document.createElement("span");U.className=l.winner==="A"?"badge-a":l.winner==="B"?"badge-b":"badge-tie",U.textContent=l.winner==="T"?"TIE":"WIN",E.appendChild(U),y.appendChild(b),y.appendChild(B),y.appendChild(E),C.appendChild(y)}))}function j(){const{undoStack:e,...t}=o;localStorage.setItem("punchBuggy",JSON.stringify(t))}function H(){const e=localStorage.getItem("punchBuggy");if(e){const t=JSON.parse(e);t.roundWinners&&Array.isArray(t.roundWinners)&&(t.roundWinners=t.roundWinners.map(a=>typeof a=="string"?a==="A"?{winner:"A",scoreA:0,scoreB:0}:a==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:a)),Object.assign(o,t)}o.undoStack=[],p()}function v(e){o.history.push(e),p()}function k(e,t=1){F();const a=e==="A"?"B":"A";o.players[e].score=Math.max(0,o.players[e].score+t),t>0?(o.players[e].streak++,o.players[a].streak=0,n(`.card[data-player="${e}"]`).classList.add("winner"),setTimeout(()=>n(`.card[data-player="${e}"]`).classList.remove("winner"),600),n(`.card[data-player="${a}"]`).classList.add("loser"),setTimeout(()=>n(`.card[data-player="${a}"]`).classList.remove("loser"),500),n(`#score${e}`).classList.add("bump"),setTimeout(()=>n(`#score${e}`).classList.remove("bump"),500),v(`${o.players[e].name} spotted a bug! +1`)):(o.players[e].streak=0,v(`${o.players[e].name} correction: -1`)),p()}function F(){const{undoStack:e,...t}=o;e.push(JSON.parse(JSON.stringify(t))),e.length>50&&e.shift()}function Y(){confirm("Reset entire game? This will also clear round history.")&&(o.round=1,Object.values(o.players).forEach(e=>{e.score=0,e.streak=0}),o.history=[],o.roundWinners=[],p())}function D(){if(!o.undoStack.length)return;const e=o.undoStack.pop(),{undoStack:t,...a}=o;Object.assign(o,e),o.undoStack=t,p()}function J(){const e=o.players.A.score,t=o.players.B.score;let a="T";e>t?a="A":t>e&&(a="B"),o.roundWinners.push({winner:a,scoreA:e,scoreB:t}),v(a==="T"?`ðŸ¤ Round ${o.round} tied ${e}-${t}`:a==="A"?`ðŸ† ${o.players.A.name} won Round ${o.round} ${e}-${t}`:`ðŸ† ${o.players.B.name} won Round ${o.round} ${t}-${e}`)}function q(){J(),o.round++,Object.values(o.players).forEach(e=>{e.score=0,e.streak=0}),v(`ðŸ Round ${o.round} started!`),p()}function G(e,t){if(!t||!t.type.startsWith("image/"))return;const a=new FileReader;a.onload=i=>{o.players[e].avatar=i.target.result,p()},a.readAsDataURL(t)}n("#btnA").onclick=()=>k("A",1);n("#btnB").onclick=()=>k("B",1);n("#minusA").onclick=()=>k("A",-1);n("#minusB").onclick=()=>k("B",-1);n("#resetBtn").onclick=Y;n("#undoBtn").onclick=D;n("#nextRound").onclick=q;function z(e){const t=n("#leaderboardWrap");t.style.display="none"}n("#clearBoard").onclick=()=>{confirm("Clear round history?")&&(o.roundWinners=[],p())};n("#closeBoard").onclick=()=>z();function K(){document.body.style.overflow="hidden",n("#leaderboardView").style.display="block",R()}function Q(){document.body.style.overflow="",n("#leaderboardView").style.display="none"}n("#leaderboardBtn").onclick=()=>K();n("#closeFull").onclick=()=>Q();const w=n("#menuPanel"),N=n("#menuBtn");function W(e){if(!w)return;const t=typeof e=="boolean"?e:!w.classList.contains("open");w.classList.toggle("open",t),w.setAttribute("aria-hidden",t?"false":"true"),w.inert=!t,!t&&N&&w.contains(document.activeElement)&&N.focus()}N&&(N.onclick=()=>W());const X=["Objective: Spot the VW Beetle (or other agreed target) first to score a point.","Scoring: First player to call it gets +1. Use the correction (-1) for false calls.","Rounds: Press Next Round to record the round winner and start fresh scores for the next round.","Streaks: Consecutive correct calls increase your streak but do not change round scoring.","Safety: Keep your eyes on the road. No taking photos or reaching for phones while driving.","Fair Play: Disputes are resolved by mutual agreement; use -1 for honest corrections.","Tie Rounds: If both players have equal scores when Next Round is pressed, the round is recorded as a tie.","Customization: Change player names or avatars before/after rounds. Avatars are local only."];n("#rulesBtn").onclick=()=>{W(!1);const e=n("#rulesContent");e.innerHTML='<ol style="margin:0;padding-left:18px">'+X.map(t=>`<li style="margin-bottom:8px">${t}</li>`).join("")+"</ol>",n("#rulesModal").style.display="flex"};n("#dataBtn").onclick=()=>{W(!1),n("#dataModal").style.display="flex",M()};n("#closeData").onclick=()=>{n("#dataModal").style.display="none"};async function Z(){o.round=1,o.players.A={name:"Player A",score:0,streak:0,avatar:""},o.players.B={name:"Player B",score:0,streak:0,avatar:""},o.history=[],o.roundWinners=[],p();try{localStorage.removeItem("punchBuggy")}catch(e){console.warn("Failed to clear localStorage",e)}}n("#clearData").onclick=()=>{confirm("Delete all game data (rounds, scores, history, names, avatars)?")&&Z()};n("#exportData").onclick=()=>{const e=JSON.stringify(o,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),i=document.createElement("a");i.href=a,i.download=`punchbuggy-export-${Date.now()}.json`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(a)};function ee(e){if(!e||typeof e!="object")return{error:"invalid"};const t=e.data&&typeof e.data=="object"?e.data:e,a={};a.players={A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},t.players&&typeof t.players=="object"&&["A","B"].forEach(r=>{const s=t.players[r]||{},c=typeof s.name=="string"&&s.name.trim()?s.name.trim():a.players[r].name,g=typeof s.avatar=="string"?s.avatar:"";let h=0,m=0;s.current&&typeof s.current=="object"?(h=Number(s.current.score)||0,m=Number(s.current.streak)||0):(h=Number(s.score)||0,m=Number(s.streak)||0),a.players[r]={name:c,score:h,streak:m,avatar:g}}),Number.isFinite(Number(t.round))?a.round=Math.max(1,Math.round(Number(t.round))):t.rounds&&t.rounds.current&&Number.isFinite(Number(t.rounds.current.number))?a.round=Math.max(1,Math.round(Number(t.rounds.current.number))):a.round=1,a.roundWinners=[],t.rounds&&Array.isArray(t.rounds.history)?a.roundWinners=t.rounds.history.map(r=>{const s=r&&r.winner?r.winner:"T",c=r&&r.scores&&Number.isFinite(Number(r.scores.A))?Number(r.scores.A):0,g=r&&r.scores&&Number.isFinite(Number(r.scores.B))?Number(r.scores.B):0;return{winner:s,scoreA:c,scoreB:g}}):Array.isArray(t.roundWinners)&&(a.roundWinners=t.roundWinners.map(r=>typeof r=="string"?r==="A"?{winner:"A",scoreA:0,scoreB:0}:r==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:r).filter(Boolean)),Array.isArray(t.history)?a.history=t.history.map(r=>{if(typeof r=="string")return r;if(r&&r.message)return r.message;try{return JSON.stringify(r)}catch{return String(r)}}):a.history=[];const i=t.schemaVersion||e.schemaVersion;return i&&(a.schemaVersion=i),a}n("#importBtn").onclick=()=>n("#importFile").click();n("#importFile").onchange=async e=>{const t=e.target.files&&e.target.files[0];if(t){try{const a=await t.text(),i=JSON.parse(a),r=ee(i);if(r&&r.error){alert("Invalid file: could not parse import"),e.target.value="";return}if(!confirm("Importing will replace your current game state. Continue?")){e.target.value="";return}Object.assign(o,r),p(),alert("Import successful")}catch(a){alert("Failed to import: "+(a&&a.message?a.message:String(a)))}e.target.value=""}};n("#closeRules").onclick=()=>{n("#rulesModal").style.display="none"};n("#nameA").onchange=e=>{o.players.A.name=e.target.value,p()};n("#nameB").onchange=e=>{o.players.B.name=e.target.value,p()};n("#uploadA").onchange=e=>G("A",e.target.files[0]);n("#uploadB").onchange=e=>G("B",e.target.files[0]);function ne(){if(!("serviceWorker"in navigator))return;window.PUNCHBUGGY_AUTO_APPLY_UPDATES=window.PUNCHBUGGY_AUTO_APPLY_UPDATES===void 0?!1:!!window.PUNCHBUGGY_AUTO_APPLY_UPDATES;const e=n("#updateBanner"),t=n("#updateBannerText"),a=n("#refreshUpdate"),i=n("#dismissUpdate"),r=document.documentElement;let s=null,c=null;function g(){if(!e||e.style.display==="none")return;const u=()=>{const f=e.getBoundingClientRect().height||0;r&&r.style.setProperty("--update-banner-offset",`${Math.ceil(f+16)}px`)};window.requestAnimationFrame?requestAnimationFrame(()=>requestAnimationFrame(u)):setTimeout(u,0)}function h(){c&&clearTimeout(c),c=null,e&&(e.style.display="none"),s=null,r&&r.style.setProperty("--update-banner-offset","0px")}function m(){if(s){const u=s;localStorage.setItem("punchBuggy_running_version",window.PUNCHBUGGY_APP_VERSION||"unknown"),console.log("[PunchBuggy] Update requested, new version will be:",window.PUNCHBUGGY_APP_VERSION),h(),u.postMessage({type:"SKIP_WAITING"})}}function P(u){if(s=u,!!e){if(t){const f=window.PUNCHBUGGY_APP_VERSION||"latest";t.textContent=`Version ${f} is ready. Refresh to load the latest updates.`}e.style.display="flex",g(),c&&clearTimeout(c),window.PUNCHBUGGY_AUTO_APPLY_UPDATES?c=setTimeout(()=>{s&&m()},3e4):c=null}}a&&(a.onclick=()=>m()),i&&(i.onclick=()=>h()),window.addEventListener("resize",g),window.DEBUG_showUpdateBanner=function(u){try{if(!e)return;t&&(t.textContent=u||`Version ${window.PUNCHBUGGY_APP_VERSION||"latest"} is ready. Refresh to load the latest updates.`),e.style.display="flex",g()}catch(f){console.warn("DEBUG_showUpdateBanner failed",f)}},navigator.serviceWorker.addEventListener("controllerchange",()=>{s&&window.location.reload()}),navigator.serviceWorker.register("/service-worker.js").then(u=>{u.waiting&&P(u.waiting),u.addEventListener("updatefound",()=>{const f=u.installing;f&&f.addEventListener("statechange",()=>{f.state==="installed"&&navigator.serviceWorker.controller&&P(f)})}),setInterval(()=>{document.visibilityState==="visible"&&u.update()},5*60*1e3)}).catch(u=>{console.error("Service worker registration failed:",u)})}try{if(window.PunchBuggyMigrations&&typeof window.PunchBuggyMigrations.migrateIfNeeded=="function"){const e=window.PunchBuggyMigrations.migrateIfNeeded();if(e&&e.migrated){const t=document.getElementById("modalLog");t&&t.insertAdjacentHTML("beforeend","<li>Migrated local data to schema v2.0.0.</li>")}}}catch(e){console.error("Migration call failed",e)}H();ne();
