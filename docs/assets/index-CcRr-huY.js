(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();(function(e){function t(i){return!i||typeof i!="object"||(i.players=i.players||{},i.players.A=i.players.A||{name:"Player A",score:0,streak:0,avatar:""},i.players.B=i.players.B||{name:"Player B",score:0,streak:0,avatar:""},["A","B"].forEach(r=>{const a=i.players[r]||{};typeof a.score!="number"&&(a.score=Number(a.score)||0),typeof a.streak!="number"&&(a.streak=Number(a.streak)||0),typeof a.avatar!="string"&&(a.avatar=a.avatar||""),i.players[r]=a}),Array.isArray(i.roundWinners)?i.roundWinners=i.roundWinners.map(r=>r?typeof r=="string"?r==="A"?{winner:"A",scoreA:0,scoreB:0}:r==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:r:null).filter(Boolean):i.roundWinners=i.roundWinners||[],i.round=i.round||1,i.history=Array.isArray(i.history)?i.history:i.history?[i.history]:[],i.schemaVersion="2.0.0"),i}function s(){try{const i=localStorage.getItem("punchBuggy");if(!i)return{migrated:!1,reason:"no-state"};let r=null;try{r=JSON.parse(i)}catch(c){return{migrated:!1,reason:"invalid-json",error:c}}if(r&&r.schemaVersion==="2.0.0")return{migrated:!1,reason:"already-v2"};const a=t(r);return localStorage.setItem("punchBuggy",JSON.stringify(a)),{migrated:!0,nextState:a}}catch(i){return console.error("Migration failed",i),{migrated:!1,reason:"exception",error:i}}}e.PunchBuggyMigrations=e.PunchBuggyMigrations||{},e.PunchBuggyMigrations.migrateIfNeeded=s})(window);const n=e=>document.querySelector(e),o={round:1,players:{A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},roundWinners:[],history:[],undoStack:[]},W=n("#appVersion");if(W){const e=localStorage.getItem("punchBuggy_running_version"),t=window.PUNCHBUGGY_APP_VERSION||"unknown",s=e||t;W.textContent=s,(!e||e!==t)&&(localStorage.setItem("punchBuggy_running_version",t),W.textContent=t)}console.log("[PunchBuggy] Version info:",{runningVersion:localStorage.getItem("punchBuggy_running_version"),fetchedVersion:window.PUNCHBUGGY_APP_VERSION,autoApplyEnabled:window.PUNCHBUGGY_AUTO_APPLY_UPDATES});function p(){n("#scoreA").textContent=o.players.A.score,n("#scoreB").textContent=o.players.B.score,I(n("#streakA"),o.players.A.streak),I(n("#streakB"),o.players.B.streak),n("#nameA").value=o.players.A.name,n("#nameB").value=o.players.B.name,o.players.A.avatar&&(n("#avatarA").src=o.players.A.avatar),o.players.B.avatar&&(n("#avatarB").src=o.players.B.avatar),n("#round").textContent=o.round;const e=o.players.A.score-o.players.B.score;n("#lead").textContent=e===0?"Tied":e>0?`${o.players.A.name} +${e}`:`${o.players.B.name} +${Math.abs(e)}`,R();const t=o.players.A.score===o.players.B.score?null:o.players.A.score>o.players.B.score?"A":"B";t==="A"?(n("#crownA").style.display="flex",n("#crownB").style.display="none"):t==="B"?(n("#crownB").style.display="flex",n("#crownA").style.display="none"):(n("#crownA").style.display="none",n("#crownB").style.display="none"),M(),j()}const V=["smolder","burning","inferno"];function I(e,t){e&&(e.classList.remove(...V),e.innerHTML=`<span class="fire-icon">ðŸ”¥</span> ${t} Streak`,t>=10?e.classList.add("inferno"):t>=5?e.classList.add("burning"):t>=3&&e.classList.add("smolder"))}function M(){const e=n("#modalLog");e&&(e.innerHTML=o.history.slice().reverse().map(t=>`<li style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)">${t}</li>`).join(""))}function R(){const e=o.roundWinners.map(l=>l?typeof l=="string"?l==="A"?{winner:"A",scoreA:0,scoreB:0}:l==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:l:null).filter(Boolean),t=n("#miniList");t.innerHTML="",e.forEach((l,S)=>{const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="space-between",d.style.gap="12px",d.style.padding="8px",d.style.borderRadius="10px",d.style.background="linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))";const y=document.createElement("div");y.style.display="flex",y.style.alignItems="center",y.style.gap="10px";const A=document.createElement("div");A.className="token",A.textContent=S+1,A.style.width="34px",A.style.height="34px",A.style.fontSize="14px";const b=document.createElement("div");b.style.fontWeight="700",b.textContent=l.winner==="T"?"Tie":l.winner==="A"?o.players.A.name:o.players.B.name,y.appendChild(A),y.appendChild(b);const h=document.createElement("div");h.style.fontWeight="800",h.textContent=`${l.scoreA} â€” ${l.scoreB}`,l.winner==="A"?d.style.borderLeft="4px solid rgba(93,212,162,0.9)":l.winner==="B"&&(d.style.borderLeft="4px solid rgba(138,168,255,0.9)"),t.appendChild(d),d.appendChild(y),d.appendChild(h)});let s=0,i=0,r=0,a=0,c=0;e.forEach(l=>{s+=l.scoreA,i+=l.scoreB,l.winner==="A"?r++:l.winner==="B"?a++:c++});const B=s+i,m=r+a,g=m?Math.round(r/m*100):50,P=100-g,N=o.players.A.avatar||n("#avatarA").src,u=o.players.B.avatar||n("#avatarB").src;n("#lbAvatarA")&&(n("#lbAvatarA").src=N),n("#lbAvatarB")&&(n("#lbAvatarB").src=u),n("#lbNameA")&&(n("#lbNameA").textContent=o.players.A.name),n("#lbNameB")&&(n("#lbNameB").textContent=o.players.B.name),n("#lbWinsA")&&(n("#lbWinsA").textContent=r),n("#lbWinsB")&&(n("#lbWinsB").textContent=a),n("#lbPercentA")&&(n("#lbPercentA").textContent=`${g}%`),n("#lbPercentB")&&(n("#lbPercentB").textContent=`${P}%`),n("#lbMeterA")&&(n("#lbMeterA").style.width=`${g}%`),n("#lbMeterB")&&(n("#lbMeterB").style.width=`${P}%`),n("#lbTotalRounds")&&(n("#lbTotalRounds").textContent=e.length),n("#lbTotalTies")&&(n("#lbTotalTies").textContent=c),n("#lbTotalPunches")&&(n("#lbTotalPunches").textContent=B),n("#lbHistoryCount")&&(n("#lbHistoryCount").textContent=e.length);const f=n("#lbPlayerA"),O=n("#lbPlayerB");f&&f.classList.toggle("winner",r>a),O&&O.classList.toggle("winner",a>r),n("#lbCrownA")&&(n("#lbCrownA").style.display=r>a?"block":"none"),n("#lbCrownB")&&(n("#lbCrownB").style.display=a>r?"block":"none");const x=n("#roundList");x&&(x.innerHTML="",e.slice().reverse().forEach((l,S)=>{const d=e.length-S,y=document.createElement("div"),A=l.winner==="A"?"win-a":l.winner==="B"?"win-b":"tie";y.className=`round-item ${A}`;const b=document.createElement("div");b.className="round-num",b.textContent=`#${d}`;const h=document.createElement("div");h.className="round-scores";const L=document.createElement("span");L.className=`score-val p1 ${l.scoreA>l.scoreB?"winner":"dim"}`,L.textContent=l.scoreA;const T=document.createElement("span");T.className="round-divider",T.textContent="â€”";const E=document.createElement("span");E.className=`score-val p2 ${l.scoreB>l.scoreA?"winner":"dim"}`,E.textContent=l.scoreB,h.appendChild(L),h.appendChild(T),h.appendChild(E);const U=document.createElement("div");U.className="round-badge";const $=document.createElement("span");$.className=l.winner==="A"?"badge-a":l.winner==="B"?"badge-b":"badge-tie",$.textContent=l.winner==="T"?"TIE":"WIN",U.appendChild($),y.appendChild(b),y.appendChild(h),y.appendChild(U),x.appendChild(y)}))}function j(){const{undoStack:e,...t}=o;localStorage.setItem("punchBuggy",JSON.stringify(t))}function H(){const e=localStorage.getItem("punchBuggy");if(e){const t=JSON.parse(e);t.roundWinners&&Array.isArray(t.roundWinners)&&(t.roundWinners=t.roundWinners.map(s=>typeof s=="string"?s==="A"?{winner:"A",scoreA:0,scoreB:0}:s==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:s)),Object.assign(o,t)}o.undoStack=[],p()}function v(e){o.history.push(e),p()}function C(e,t=1){F();const s=e==="A"?"B":"A";o.players[e].score=Math.max(0,o.players[e].score+t),t>0?(o.players[e].streak++,o.players[s].streak=0,n(`.card[data-player="${e}"]`).classList.add("winner"),setTimeout(()=>n(`.card[data-player="${e}"]`).classList.remove("winner"),600),n(`.card[data-player="${s}"]`).classList.add("loser"),setTimeout(()=>n(`.card[data-player="${s}"]`).classList.remove("loser"),500),n(`#score${e}`).classList.add("bump"),setTimeout(()=>n(`#score${e}`).classList.remove("bump"),500),v(`${o.players[e].name} spotted a bug! +1`)):(o.players[e].streak=0,v(`${o.players[e].name} correction: -1`)),p()}function F(){const{undoStack:e,...t}=o;e.push(JSON.parse(JSON.stringify(t))),e.length>50&&e.shift()}function Y(){confirm("Reset entire game? This will also clear round history.")&&(o.round=1,Object.values(o.players).forEach(e=>{e.score=0,e.streak=0}),o.history=[],o.roundWinners=[],p())}function D(){if(!o.undoStack.length)return;const e=o.undoStack.pop(),{undoStack:t,...s}=o;Object.assign(o,e),o.undoStack=t,p()}function J(){const e=o.players.A.score,t=o.players.B.score;let s="T";e>t?s="A":t>e&&(s="B"),o.roundWinners.push({winner:s,scoreA:e,scoreB:t}),v(s==="T"?`ðŸ¤ Round ${o.round} tied ${e}-${t}`:s==="A"?`ðŸ† ${o.players.A.name} won Round ${o.round} ${e}-${t}`:`ðŸ† ${o.players.B.name} won Round ${o.round} ${t}-${e}`)}function q(){J(),o.round++,Object.values(o.players).forEach(e=>{e.score=0,e.streak=0}),v(`ðŸ Round ${o.round} started!`),p()}function G(e,t){if(!t||!t.type.startsWith("image/"))return;const s=new FileReader;s.onload=i=>{o.players[e].avatar=i.target.result,p()},s.readAsDataURL(t)}n("#btnA").onclick=()=>C("A",1);n("#btnB").onclick=()=>C("B",1);n("#minusA").onclick=()=>C("A",-1);n("#minusB").onclick=()=>C("B",-1);n("#resetBtn").onclick=Y;n("#undoBtn").onclick=D;n("#nextRound").onclick=q;function z(e){const t=n("#leaderboardWrap");t.style.display="none"}n("#clearBoard").onclick=()=>{confirm("Clear round history?")&&(o.roundWinners=[],p())};n("#closeBoard").onclick=()=>z();function K(){document.body.style.overflow="hidden",n("#leaderboardView").style.display="block",R()}function Q(){document.body.style.overflow="",n("#leaderboardView").style.display="none"}n("#leaderboardBtn").onclick=()=>K();n("#closeFull").onclick=()=>Q();const w=n("#menuPanel"),k=n("#menuBtn");function _(e){if(!w)return;const t=typeof e=="boolean"?e:!w.classList.contains("open");w.classList.toggle("open",t),w.setAttribute("aria-hidden",t?"false":"true"),w.inert=!t,!t&&k&&w.contains(document.activeElement)&&k.focus()}k&&(k.onclick=()=>_());const X=["Objective: Spot the VW Beetle (or other agreed target) first to score a point.","Scoring: First player to call it gets +1. Use the correction (-1) for false calls.","Rounds: Press Next Round to record the round winner and start fresh scores for the next round.","Streaks: Consecutive correct calls increase your streak but do not change round scoring.","Safety: Keep your eyes on the road. No taking photos or reaching for phones while driving.","Fair Play: Disputes are resolved by mutual agreement; use -1 for honest corrections.","Tie Rounds: If both players have equal scores when Next Round is pressed, the round is recorded as a tie.","Customization: Change player names or avatars before/after rounds. Avatars are local only."];n("#rulesBtn").onclick=()=>{_(!1);const e=n("#rulesContent");e.innerHTML='<ol style="margin:0;padding-left:18px">'+X.map(t=>`<li style="margin-bottom:8px">${t}</li>`).join("")+"</ol>",n("#rulesModal").style.display="flex"};n("#dataBtn").onclick=()=>{_(!1),n("#dataModal").style.display="flex",M()};n("#closeData").onclick=()=>{n("#dataModal").style.display="none"};async function Z(){o.round=1,o.players.A={name:"Player A",score:0,streak:0,avatar:""},o.players.B={name:"Player B",score:0,streak:0,avatar:""},o.history=[],o.roundWinners=[],p();try{localStorage.removeItem("punchBuggy")}catch(e){console.warn("Failed to clear localStorage",e)}}n("#clearData").onclick=()=>{confirm("Delete all game data (rounds, scores, history, names, avatars)?")&&Z()};n("#exportData").onclick=()=>{const e=JSON.stringify(o,null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`punchbuggy-export-${Date.now()}.json`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(s)};function ee(e){if(!e||typeof e!="object")return{error:"invalid"};const t=e.data&&typeof e.data=="object"?e.data:e,s={};s.players={A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},t.players&&typeof t.players=="object"&&["A","B"].forEach(r=>{const a=t.players[r]||{},c=typeof a.name=="string"&&a.name.trim()?a.name.trim():s.players[r].name,B=typeof a.avatar=="string"?a.avatar:"";let m=0,g=0;a.current&&typeof a.current=="object"?(m=Number(a.current.score)||0,g=Number(a.current.streak)||0):(m=Number(a.score)||0,g=Number(a.streak)||0),s.players[r]={name:c,score:m,streak:g,avatar:B}}),Number.isFinite(Number(t.round))?s.round=Math.max(1,Math.round(Number(t.round))):t.rounds&&t.rounds.current&&Number.isFinite(Number(t.rounds.current.number))?s.round=Math.max(1,Math.round(Number(t.rounds.current.number))):s.round=1,s.roundWinners=[],t.rounds&&Array.isArray(t.rounds.history)?s.roundWinners=t.rounds.history.map(r=>{const a=r&&r.winner?r.winner:"T",c=r&&r.scores&&Number.isFinite(Number(r.scores.A))?Number(r.scores.A):0,B=r&&r.scores&&Number.isFinite(Number(r.scores.B))?Number(r.scores.B):0;return{winner:a,scoreA:c,scoreB:B}}):Array.isArray(t.roundWinners)&&(s.roundWinners=t.roundWinners.map(r=>typeof r=="string"?r==="A"?{winner:"A",scoreA:0,scoreB:0}:r==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:r).filter(Boolean)),Array.isArray(t.history)?s.history=t.history.map(r=>{if(typeof r=="string")return r;if(r&&r.message)return r.message;try{return JSON.stringify(r)}catch{return String(r)}}):s.history=[];const i=t.schemaVersion||e.schemaVersion;return i&&(s.schemaVersion=i),s}n("#importBtn").onclick=()=>n("#importFile").click();n("#importFile").onchange=async e=>{const t=e.target.files&&e.target.files[0];if(t){try{const s=await t.text(),i=JSON.parse(s),r=ee(i);if(r&&r.error){alert("Invalid file: could not parse import"),e.target.value="";return}if(!confirm("Importing will replace your current game state. Continue?")){e.target.value="";return}Object.assign(o,r),p(),alert("Import successful")}catch(s){alert("Failed to import: "+(s&&s.message?s.message:String(s)))}e.target.value=""}};n("#closeRules").onclick=()=>{n("#rulesModal").style.display="none"};n("#nameA").onchange=e=>{o.players.A.name=e.target.value,p()};n("#nameB").onchange=e=>{o.players.B.name=e.target.value,p()};n("#uploadA").onchange=e=>G("A",e.target.files[0]);n("#uploadB").onchange=e=>G("B",e.target.files[0]);function ne(){if(!("serviceWorker"in navigator))return;window.PUNCHBUGGY_AUTO_APPLY_UPDATES=window.PUNCHBUGGY_AUTO_APPLY_UPDATES===void 0?!1:!!window.PUNCHBUGGY_AUTO_APPLY_UPDATES;const e=n("#updateBanner"),t=n("#updateBannerText"),s=n("#refreshUpdate"),i=n("#dismissUpdate"),r=document.documentElement;let a=null,c=null,B=!1;function m(){if(!e||e.style.display==="none")return;const u=()=>{const f=e.getBoundingClientRect().height||0;r&&r.style.setProperty("--update-banner-offset",`${Math.ceil(f+16)}px`)};window.requestAnimationFrame?requestAnimationFrame(()=>requestAnimationFrame(u)):setTimeout(u,0)}function g(){c&&clearTimeout(c),c=null,e&&(e.style.display="none"),a=null,r&&r.style.setProperty("--update-banner-offset","0px")}function P(){if(a){const u=a;B=!0,localStorage.setItem("punchBuggy_running_version",window.PUNCHBUGGY_APP_VERSION||"unknown"),console.log("[PunchBuggy] Update requested, new version will be:",window.PUNCHBUGGY_APP_VERSION),g(),u.postMessage({type:"SKIP_WAITING"})}}function N(u){if(a=u,!!e){if(t){const f=window.PUNCHBUGGY_APP_VERSION||"latest";t.textContent=`Version ${f} is ready. Refresh to load the latest updates.`}e.style.display="flex",m(),c&&clearTimeout(c),window.PUNCHBUGGY_AUTO_APPLY_UPDATES?c=setTimeout(()=>{a&&P()},3e4):c=null}}s&&(s.onclick=()=>P()),i&&(i.onclick=()=>g()),window.addEventListener("resize",m),window.DEBUG_showUpdateBanner=function(u){try{if(!e)return;t&&(t.textContent=u||`Version ${window.PUNCHBUGGY_APP_VERSION||"latest"} is ready. Refresh to load the latest updates.`),e.style.display="flex",m()}catch(f){console.warn("DEBUG_showUpdateBanner failed",f)}},navigator.serviceWorker.addEventListener("controllerchange",()=>{B&&window.location.reload()}),navigator.serviceWorker.register("/service-worker.js").then(u=>{u.waiting&&N(u.waiting),u.addEventListener("updatefound",()=>{const f=u.installing;f&&f.addEventListener("statechange",()=>{f.state==="installed"&&navigator.serviceWorker.controller&&N(f)})}),setInterval(()=>{document.visibilityState==="visible"&&u.update()},5*60*1e3)}).catch(u=>{console.error("Service worker registration failed:",u)})}try{if(window.PunchBuggyMigrations&&typeof window.PunchBuggyMigrations.migrateIfNeeded=="function"){const e=window.PunchBuggyMigrations.migrateIfNeeded();if(e&&e.migrated){const t=document.getElementById("modalLog");t&&t.insertAdjacentHTML("beforeend","<li>Migrated local data to schema v2.0.0.</li>")}}}catch(e){console.error("Migration call failed",e)}H();ne();
