(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function n(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(e){if(e.ep)return;e.ep=!0;const a=n(e);fetch(e.href,a)}})();(function(){const t=typeof window<"u"&&typeof indexedDB<"u",r="punchbuggy-auto-backup-enabled",n="punchbuggy-auto-backup-meta",c={DB_NAME:"punchbuggy-auto-backup",DB_VERSION:1,STORE_NAME:"backups",META_KEY:"metadata",BACKUP_CURRENT_KEY:"current",BACKUP_PREVIOUS_KEY:"previous",BACKUP_OLDEST_KEY:"oldest",AUTO_DELAY_MS:5e3,MAX_HISTORY_SNAPSHOTS:200,MAX_ROUND_SNAPSHOTS:200,SUPPORTED:t,_dbPromise:null,_callbacks:new Set,_pendingTimer:null,_busy:!1,_getState:null,_applyState:null,_status:{code:t?"idle":"unsupported",message:t?"Automatic backups ready.":"Automatic backups require IndexedDB support.",enabled:t},_lastHash:"",enabled:!0,metadata:{lastBackupISO:"",currentBackupDate:"",previousBackupDate:"",oldestBackupDate:"",backupCount:0}};c.init=async function(e={}){this._getState=typeof e.getState=="function"?e.getState:null,this._applyState=typeof e.applyState=="function"?e.applyState:null,e.onStatusChange&&this.onStatusChange(e.onStatusChange),this.enabled=this._loadEnabledFlag();const a=this._loadCachedMetadata();if(a&&(this.metadata=Object.assign({},this.metadata,a),a.lastHash&&(this._lastHash=a.lastHash)),!this.SUPPORTED){this._updateStatus({code:"unsupported",message:"Automatic backups require IndexedDB support.",enabled:!1});return}try{if(await this._openDb(),await this._loadMetadataFromDb(),this.enabled){const i=this.metadata.currentBackupDate?"Automatic backups ready.":"Automatic backups will start after your next change.";this._updateStatus({code:"idle",message:i})}else this._updateStatus({code:"disabled",message:"Automatic backups are disabled by the user.",enabled:!1})}catch(i){console.error("[AutoBackup] init error",i),this._updateStatus({code:"error",message:"Automatic backup initialization failed.",error:i,enabled:!1})}},c.onStatusChange=function(e){return typeof e=="function"&&(this._callbacks.add(e),e(this.getStatus())),()=>this._callbacks.delete(e)},c.getStatus=function(){const e=Object.assign({},this._status);return e.enabled=this.enabled&&this.SUPPORTED,e.pending=!!this._pendingTimer,e.metadata=Object.assign({},this.metadata),e},c.setEnabled=function(e){const a=!!e;if(a===this.enabled){this._updateStatus(this.getStatus());return}if(this.enabled=a,this._persistEnabledFlag(a),!a&&this._pendingTimer&&(clearTimeout(this._pendingTimer),this._pendingTimer=null),!a)this._updateStatus({code:"disabled",message:"Automatic backups are disabled by the user.",enabled:!1});else{const i=this.metadata.currentBackupDate?"Automatic backups ready.":"Automatic backups will start after your next change.";this._updateStatus({code:"idle",message:i,enabled:!0}),this.handleStoreSave("enabled-toggle")}},c.handleStoreSave=function(e="auto"){!this.SUPPORTED||!this.enabled||(this._pendingTimer&&clearTimeout(this._pendingTimer),this._pendingTimer=setTimeout(()=>{this._pendingTimer=null,this.performBackup(e).catch(a=>console.error("[AutoBackup] performBackup failed",a))},this.AUTO_DELAY_MS))},c.performBackup=async function(e="auto"){if(!this.SUPPORTED)return;if(!this.enabled){this._updateStatus({code:"disabled",message:"Automatic backups are disabled by the user.",enabled:!1});return}if(this._busy)return;const a=this._buildEntry(e);if(!a)return;const i=JSON.stringify(a.data),p=await this._hash(i);if(p&&this._lastHash&&p===this._lastHash){this._updateStatus({code:"no-change",message:"Backup skipped ‚Äî no changes detected."});return}this._busy=!0;try{this._updateStatus({code:"busy",message:"Saving automatic backup‚Ä¶"});const l=(await this._openDb()).transaction(this.STORE_NAME,"readwrite"),y=l.objectStore(this.STORE_NAME),u=y.get(this.BACKUP_CURRENT_KEY),d=y.get(this.BACKUP_PREVIOUS_KEY),h=y.get(this.BACKUP_OLDEST_KEY);await Promise.all([this._requestToPromise(u),this._requestToPromise(d),this._requestToPromise(h)]);const m=u.result||null,A=d.result||null,$=h.result||null;A?y.put(A,this.BACKUP_OLDEST_KEY):$||y.delete(this.BACKUP_OLDEST_KEY),m?y.put(m,this.BACKUP_PREVIOUS_KEY):y.delete(this.BACKUP_PREVIOUS_KEY),y.put({savedAt:a.savedAt,hash:p,version:a.version,reason:e,data:a.data},this.BACKUP_CURRENT_KEY),y.put({lastBackupISO:a.savedAt,lastHash:p},this.META_KEY),await this._txDone(l),this._lastHash=p,await this._loadMetadataFromDb(),this._updateStatus({code:"success",message:"Backup saved successfully."})}catch(f){console.error("[AutoBackup] performBackup error",f),this._updateStatus({code:"error",message:"Automatic backup failed.",error:f})}finally{this._busy=!1}},c.manualBackup=async function(){if(!this.SUPPORTED)throw new Error("Automatic backups are not supported in this browser.");const e=this._buildEntry("manual-download");if(!e)throw new Error("Unable to collect app state for backup.");const a={app:"Punch Buggy",createdAt:e.savedAt,version:e.version,data:e.data},i=JSON.stringify(a,null,2),p=new Blob([i],{type:"application/json"}),l=`punchbuggy-backup-${e.savedAt.replace(/[:]/g,"-")}.json`,y=URL.createObjectURL(p),u=document.createElement("a");u.href=y,u.download=l,u.style.display="none",document.body.appendChild(u),u.click(),document.body.removeChild(u),setTimeout(()=>URL.revokeObjectURL(y),5e3),this._updateStatus({code:"downloaded",message:"Backup downloaded."})},c.listBackups=async function(){if(!this.SUPPORTED)return[];const a=(await this._openDb()).transaction(this.STORE_NAME,"readonly"),i=a.objectStore(this.STORE_NAME),f=[this.BACKUP_CURRENT_KEY,this.BACKUP_PREVIOUS_KEY,this.BACKUP_OLDEST_KEY].map(y=>this._requestToPromise(i.get(y)).then(u=>u?{key:y,savedAt:u.savedAt,version:u.version||"unknown"}:null)),l=(await Promise.all(f)).filter(Boolean);return await this._txDone(a).catch(()=>{}),l},c.restoreFromBackup=async function(e){if(!this.SUPPORTED)throw new Error("Automatic backups are not supported in this browser.");if(!new Set([this.BACKUP_CURRENT_KEY,this.BACKUP_PREVIOUS_KEY,this.BACKUP_OLDEST_KEY]).has(e))throw new Error("Unknown backup slot.");const p=(await this._openDb()).transaction(this.STORE_NAME,"readonly"),f=p.objectStore(this.STORE_NAME),l=await this._requestToPromise(f.get(e));if(await this._txDone(p).catch(()=>{}),!l||!l.data)throw new Error("Selected backup slot is empty.");const y=JSON.parse(JSON.stringify(l.data));if(this._applyState)try{this._applyState(y)}catch(u){throw console.error("[AutoBackup] applyState error",u),u}return this._updateStatus({code:"restored",message:`Restored ${e} backup from ${l.savedAt||"unknown time"}.`}),y},c._buildEntry=function(e){if(typeof this._getState!="function")return null;let a;try{a=this._getState()}catch(f){return console.error("[AutoBackup] getState error",f),null}if(!a||typeof a!="object")return null;const i=this._cloneState(a);return{savedAt:new Date().toISOString(),version:typeof window<"u"&&window.PUNCHBUGGY_APP_VERSION||"dev",reason:e,data:i}},c._cloneState=function(e){const a=JSON.parse(JSON.stringify(e));return Array.isArray(a.history)&&a.history.length>this.MAX_HISTORY_SNAPSHOTS&&(a.history=a.history.slice(-this.MAX_HISTORY_SNAPSHOTS)),Array.isArray(a.roundWinners)&&a.roundWinners.length>this.MAX_ROUND_SNAPSHOTS&&(a.roundWinners=a.roundWinners.slice(-this.MAX_ROUND_SNAPSHOTS)),a},c._openDb=function(){return this.SUPPORTED?this._dbPromise?this._dbPromise:(this._dbPromise=new Promise((e,a)=>{const i=indexedDB.open(this.DB_NAME,this.DB_VERSION);i.onupgradeneeded=()=>{const p=i.result;p.objectStoreNames.contains(this.STORE_NAME)||p.createObjectStore(this.STORE_NAME)},i.onsuccess=()=>e(i.result),i.onerror=()=>a(i.error)}),this._dbPromise):Promise.reject(new Error("IndexedDB is not available."))},c._loadMetadataFromDb=async function(){try{const a=(await this._openDb()).transaction(this.STORE_NAME,"readonly"),i=a.objectStore(this.STORE_NAME),p=i.get(this.META_KEY),f=i.get(this.BACKUP_CURRENT_KEY),l=i.get(this.BACKUP_PREVIOUS_KEY),y=i.get(this.BACKUP_OLDEST_KEY);await Promise.all([this._requestToPromise(p),this._requestToPromise(f),this._requestToPromise(l),this._requestToPromise(y)]);const u=p.result||{},d=f.result||null,h=l.result||null,m=y.result||null;this.metadata.lastBackupISO=u.lastBackupISO||"",this.metadata.currentBackupDate=d&&d.savedAt?d.savedAt:"",this.metadata.previousBackupDate=h&&h.savedAt?h.savedAt:"",this.metadata.oldestBackupDate=m&&m.savedAt?m.savedAt:"";const A=[d,h,m].filter(Boolean).length;this.metadata.backupCount=A,this._lastHash=u.lastHash||this._lastHash||"",this._persistMetadataCache(Object.assign({},this.metadata,{lastHash:this._lastHash})),await this._txDone(a).catch(()=>{})}catch(e){console.warn("[AutoBackup] load metadata error",e)}},c._hash=async function(e){try{if(window.crypto&&window.crypto.subtle){const p=new TextEncoder().encode(e),f=await window.crypto.subtle.digest("SHA-256",p);return Array.from(new Uint8Array(f)).map(l=>l.toString(16).padStart(2,"0")).join("")}}catch(i){console.warn("[AutoBackup] crypto.subtle unavailable",i)}let a=0;for(let i=0;i<e.length;i++)a=(a<<5)-a+e.charCodeAt(i),a|=0;return`fallback-${Math.abs(a)}`},c._updateStatus=function(e){(!e||typeof e!="object")&&(e={});const a={code:this.enabled?"idle":"disabled",message:this.enabled?"Automatic backups ready.":"Automatic backups are disabled by the user.",enabled:this.enabled&&this.SUPPORTED};this._status=Object.assign(a,e),this._status.metadata=Object.assign({},this.metadata),this._status.enabled=this.enabled&&this.SUPPORTED&&this._status.enabled!==!1,this._callbacks.forEach(i=>{try{i(this.getStatus())}catch(p){console.error("[AutoBackup] status callback error",p)}})},c._requestToPromise=function(e){return new Promise((a,i)=>{e.onsuccess=()=>a(e.result),e.onerror=()=>i(e.error)})},c._txDone=function(e){return new Promise((a,i)=>{e.oncomplete=()=>a(),e.onabort=()=>i(e.error||new Error("Transaction aborted")),e.onerror=()=>i(e.error)})},c._loadEnabledFlag=function(){try{const e=localStorage.getItem(r);return e===null?!0:e==="true"}catch(e){return console.warn("[AutoBackup] unable to read enabled flag",e),!0}},c._persistEnabledFlag=function(e){try{localStorage.setItem(r,e?"true":"false")}catch(a){console.warn("[AutoBackup] unable to persist enabled flag",a)}},c._loadCachedMetadata=function(){try{const e=localStorage.getItem(n);return e?JSON.parse(e):null}catch(e){return console.warn("[AutoBackup] unable to parse cached metadata",e),null}},c._persistMetadataCache=function(e){try{localStorage.setItem(n,JSON.stringify(e))}catch(a){console.warn("[AutoBackup] unable to persist metadata cache",a)}},typeof window<"u"&&(window.AutoBackup=c,window.PunchBuggyAutoBackup=c,window.PunchBuggyBackup=c)})();(function(t){function r(e){try{const a="punchBuggy_backup_"+Date.now();return localStorage.setItem(a,e),localStorage.setItem("punchBuggy_last_backup",a),a}catch(a){return console.warn("Backup failed",a),null}}function n(e){return!e||typeof e!="object"||(e.players=e.players||{},e.players.A=e.players.A||{name:"Player A",score:0,streak:0,avatar:""},e.players.B=e.players.B||{name:"Player B",score:0,streak:0,avatar:""},["A","B"].forEach(a=>{const i=e.players[a]||{};typeof i.score!="number"&&(i.score=Number(i.score)||0),typeof i.streak!="number"&&(i.streak=Number(i.streak)||0),typeof i.avatar!="string"&&(i.avatar=i.avatar||""),e.players[a]=i}),Array.isArray(e.roundWinners)?e.roundWinners=e.roundWinners.map(a=>a?typeof a=="string"?a==="A"?{winner:"A",scoreA:0,scoreB:0}:a==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:a:null).filter(Boolean):e.roundWinners=e.roundWinners||[],e.round=e.round||1,e.history=Array.isArray(e.history)?e.history:e.history?[e.history]:[],e.schemaVersion="2.0.0"),e}function c(){try{const e=localStorage.getItem("punchBuggy");if(!e)return{migrated:!1,reason:"no-state"};let a=null;try{a=JSON.parse(e)}catch(f){return{migrated:!1,reason:"invalid-json",error:f}}if(a&&a.schemaVersion==="2.0.0")return{migrated:!1,reason:"already-v2"};const i=r(e),p=n(a);return localStorage.setItem("punchBuggy",JSON.stringify(p)),{migrated:!0,backupKey:i,nextState:p}}catch(e){return console.error("Migration failed",e),{migrated:!1,reason:"exception",error:e}}}t.PunchBuggyMigrations=t.PunchBuggyMigrations||{},t.PunchBuggyMigrations.migrateIfNeeded=c})(window);const s=t=>document.querySelector(t),o={round:1,players:{A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},roundWinners:[],history:[]},g=window.AutoBackup||window.PunchBuggyAutoBackup||window.PunchBuggyBackup,T=s("#appVersion");if(T){const t=localStorage.getItem("punchBuggy_running_version"),r=window.PUNCHBUGGY_APP_VERSION||"unknown",n=t||r;T.textContent=n,(!t||t!==r)&&(localStorage.setItem("punchBuggy_running_version",r),T.textContent=r)}console.log("[PunchBuggy] Version info:",{runningVersion:localStorage.getItem("punchBuggy_running_version"),fetchedVersion:window.PUNCHBUGGY_APP_VERSION,autoApplyEnabled:window.PUNCHBUGGY_AUTO_APPLY_UPDATES});function b(){s("#scoreA").textContent=o.players.A.score,s("#scoreB").textContent=o.players.B.score,s("#streakA").textContent=`üî• ${o.players.A.streak}`,s("#streakB").textContent=`üî• ${o.players.B.streak}`,s("#nameA").value=o.players.A.name,s("#nameB").value=o.players.B.name,o.players.A.avatar&&(s("#avatarA").src=o.players.A.avatar),o.players.B.avatar&&(s("#avatarB").src=o.players.B.avatar),s("#round").textContent=o.round;const t=o.players.A.score-o.players.B.score;s("#lead").textContent=t===0?"Tied":t>0?`${o.players.A.name} +${t}`:`${o.players.B.name} +${Math.abs(t)}`,D();const r=o.players.A.score===o.players.B.score?null:o.players.A.score>o.players.B.score?"A":"B";r==="A"?(s("#crownA").style.display="flex",s("#crownB").style.display="none"):r==="B"?(s("#crownB").style.display="flex",s("#crownA").style.display="none"):(s("#crownA").style.display="none",s("#crownB").style.display="none"),R(),I()}function R(){const t=s("#modalLog");t&&(t.innerHTML=o.history.slice().reverse().map(r=>`<li style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)">${r}</li>`).join(""))}function D(){const t=o.roundWinners.map(l=>l?typeof l=="string"?l==="A"?{winner:"A",scoreA:0,scoreB:0}:l==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:l:null).filter(Boolean),r=`${o.players.A.score} ‚Äî ${o.players.B.score}`;o.players.A.score===o.players.B.score||(o.players.A.score>o.players.B.score?o.players.A.name:o.players.B.name);const n=s("#miniList");n.innerHTML="",t.forEach((l,y)=>{const u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="space-between",u.style.gap="12px",u.style.padding="8px",u.style.borderRadius="10px",u.style.background="linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))";const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.gap="10px";const h=document.createElement("div");h.className="token",h.textContent=y+1,h.style.width="34px",h.style.height="34px",h.style.fontSize="14px";const m=document.createElement("div");m.style.fontWeight="700",m.textContent=l.winner==="T"?"Tie":l.winner==="A"?o.players.A.name:o.players.B.name,d.appendChild(h),d.appendChild(m);const A=document.createElement("div");A.style.fontWeight="800",A.textContent=`${l.scoreA} ‚Äî ${l.scoreB}`,l.winner==="A"?u.style.borderLeft="4px solid rgba(93,212,162,0.9)":l.winner==="B"&&(u.style.borderLeft="4px solid rgba(138,168,255,0.9)"),n.appendChild(u),u.appendChild(d),u.appendChild(A)});const c=s("#fullList");c&&(c.innerHTML="");let e=0,a=0,i=0,p=0;t.forEach((l,y)=>{e+=l.scoreA,a+=l.scoreB,l.winner==="A"?i++:l.winner==="B"&&p++;const u=document.createElement("div");u.style.display="grid",u.style.gridTemplateColumns="1fr auto 1fr",u.style.alignItems="center",u.style.padding="10px 12px",u.style.borderRadius="10px",u.style.marginBottom="6px",u.style.background="linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))";const d=document.createElement("div");d.style.textAlign="left",d.style.fontWeight="800",d.style.fontSize="16px",d.textContent=l.scoreA;const h=document.createElement("div");h.style.textAlign="center",h.style.color="var(--muted)",h.style.fontWeight="700",h.textContent=`Round ${y+1}`;const m=document.createElement("div");m.style.textAlign="right",m.style.fontWeight="800",m.style.fontSize="16px",m.textContent=l.scoreB,l.winner==="A"?(d.style.color="var(--gold)",d.style.fontSize="20px"):l.winner==="B"?(m.style.color="var(--gold)",m.style.fontSize="20px"):(d.style.color="var(--muted)",m.style.color="var(--muted)"),u.appendChild(d),u.appendChild(h),u.appendChild(m),c.appendChild(u)}),s("#headerAvatarA")&&(s("#headerAvatarA").src=o.players.A.avatar||s("#avatarA").src),s("#headerAvatarB")&&(s("#headerAvatarB").src=o.players.B.avatar||s("#avatarB").src),s("#headerNameA")&&(s("#headerNameA").textContent=o.players.A.name),s("#headerNameB")&&(s("#headerNameB").textContent=o.players.B.name);const f=s("#scoresTotals");if(f){f.innerHTML="";const l=document.createElement("div");l.style.display="grid",l.style.gridTemplateColumns="1fr auto 1fr",l.style.alignItems="center",l.style.padding="12px",l.style.borderRadius="10px",l.style.marginTop="8px",l.style.background="linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))";const y=document.createElement("div");y.style.textAlign="left",y.innerHTML=`<div style="font-size:14px;color:var(--muted)">${o.players.A.name} Total</div><div style="font-weight:900;font-size:18px">${e}</div>`;const u=document.createElement("div");u.style.textAlign="center",u.innerHTML=`<div style="font-size:14px;color:var(--muted)">Rounds</div><div style="font-weight:900;font-size:18px">${t.length}</div>`;const d=document.createElement("div");d.style.textAlign="right",d.innerHTML=`<div style="font-size:14px;color:var(--muted)">Wins</div><div style="font-weight:900;font-size:18px">${o.players.A.name} ${i} ‚Äî ${o.players.B.name} ${p}</div>`,l.appendChild(y),l.appendChild(u),l.appendChild(d),f.appendChild(l)}s("#leaderboardSummary").innerHTML=`<div style="font-weight:700">Rounds: ${t.length} ‚Äî Live: ${r}</div><div style="font-size:13px;color:var(--muted);margin-top:6px">Wins: ${o.players.A.name} ${i} ‚Äî ${o.players.B.name} ${p} &nbsp; ‚Ä¢ &nbsp; Totals: ${o.players.A.name} ${e} ‚Äî ${o.players.B.name} ${a}</div>`,s("#headerAvatarA")&&(s("#headerAvatarA").src=o.players.A.avatar||s("#avatarA").src),s("#headerAvatarB")&&(s("#headerAvatarB").src=o.players.B.avatar||s("#avatarB").src),s("#headerNameA")&&(s("#headerNameA").textContent=o.players.A.name),s("#headerNameB")&&(s("#headerNameB").textContent=o.players.B.name)}function I(){localStorage.setItem("punchBuggy",JSON.stringify(o)),g&&typeof g.handleStoreSave=="function"&&g.handleStoreSave("auto")}function L(){const t=localStorage.getItem("punchBuggy");if(t){const r=JSON.parse(t);r.roundWinners&&Array.isArray(r.roundWinners)&&(r.roundWinners=r.roundWinners.map(n=>typeof n=="string"?n==="A"?{winner:"A",scoreA:0,scoreB:0}:n==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:n)),Object.assign(o,r)}b()}function S(t){o.history.push(t),b()}function P(t,r=1){const n=t==="A"?"B":"A";o.players[t].score=Math.max(0,o.players[t].score+r),r>0?(o.players[t].streak++,o.players[n].streak=0,s(`.card[data-player="${t}"]`).classList.add("winner"),setTimeout(()=>s(`.card[data-player="${t}"]`).classList.remove("winner"),600),s(`.card[data-player="${n}"]`).classList.add("loser"),setTimeout(()=>s(`.card[data-player="${n}"]`).classList.remove("loser"),500),s(`#score${t}`).classList.add("bump"),setTimeout(()=>s(`#score${t}`).classList.remove("bump"),500),S(`${o.players[t].name} spotted a bug! +1`),o.players[t].score%5===0&&N(),o.players[t].score>o.players[n].score&&o.players[t].score-o.players[n].score===1&&setTimeout(()=>N(),200)):(o.players[t].streak=0,S(`${o.players[t].name} correction: -1`)),b()}function K(){confirm("Reset entire game? This will also clear round history.")&&(o.round=1,Object.values(o.players).forEach(t=>{t.score=0,t.streak=0}),o.history=[],o.roundWinners=[],b())}function j(){o.history.length>0&&o.history.pop(),b()}function W(){const t=o.players.A.score,r=o.players.B.score;let n="T";t>r?n="A":r>t&&(n="B"),o.roundWinners.push({winner:n,scoreA:t,scoreB:r}),S(n==="T"?`ü§ù Round ${o.round} tied ${t}-${r}`:n==="A"?`üèÜ ${o.players.A.name} won Round ${o.round} ${t}-${r}`:`üèÜ ${o.players.B.name} won Round ${o.round} ${r}-${t}`)}function Y(){W(),o.round++,Object.values(o.players).forEach(t=>{t.score=0,t.streak=0}),S(`üèÅ Round ${o.round} started!`),b()}function N(){const t=s("#confetti");t.innerHTML="";for(let r=0;r<50;r++){const n=document.createElement("div");n.className="piece",n.style.left=Math.random()*100+"%",n.style.top="-10px",n.style.background=["#5be2b0","#8aa8ff","#ffd166","#ff6b6b"][Math.floor(Math.random()*4)],n.style.transform=`rotate(${Math.random()*360}deg)`,t.appendChild(n),n.animate([{top:"-10px",opacity:1},{top:"110%",opacity:0}],{duration:1500+Math.random()*1e3,easing:"cubic-bezier(.25,.46,.45,.94)"}),setTimeout(()=>n.remove(),3e3)}}function M(t,r){if(!r||!r.type.startsWith("image/"))return;const n=new FileReader;n.onload=c=>{o.players[t].avatar=c.target.result,b()},n.readAsDataURL(r)}s("#btnA").onclick=()=>P("A",1);s("#btnB").onclick=()=>P("B",1);s("#minusA").onclick=()=>P("A",-1);s("#minusB").onclick=()=>P("B",-1);s("#resetBtn").onclick=K;s("#undoBtn").onclick=j;s("#nextRound").onclick=Y;function H(t){const r=s("#leaderboardWrap");r.style.display="none"}s("#clearBoard").onclick=()=>{confirm("Clear round history?")&&(o.roundWinners=[],b())};s("#closeBoard").onclick=()=>H();function V(){document.body.style.overflow="hidden",s("#leaderboardView").style.display="block",D()}function F(){document.body.style.overflow="hidden",s("#leaderboardView").style.display="none"}s("#leaderboardBtn").onclick=()=>V();s("#closeFull").onclick=()=>F();const E=s("#menuPanel"),x=s("#menuBtn");function O(t){if(!E)return;const r=typeof t=="boolean"?t:!E.classList.contains("open");E.classList.toggle("open",r),E.setAttribute("aria-hidden",r?"false":"true")}x&&(x.onclick=()=>O());const q=["Objective: Spot the VW Beetle (or other agreed target) first to score a point.","Scoring: First player to call it gets +1. Use the correction (-1) for false calls.","Rounds: Press Next Round to record the round winner and start fresh scores for the next round.","Streaks: Consecutive correct calls increase your streak but do not change round scoring.","Safety: Keep your eyes on the road. No taking photos or reaching for phones while driving.","Fair Play: Disputes are resolved by mutual agreement; use -1 for honest corrections.","Milestones: Every 5 points triggers a celebration (confetti).","Tie Rounds: If both players have equal scores when Next Round is pressed, the round is recorded as a tie.","Customization: Change player names or avatars before/after rounds. Avatars are local only."];s("#rulesBtn").onclick=()=>{O(!1);const t=s("#rulesContent");t.innerHTML='<ol style="margin:0;padding-left:18px">'+q.map(r=>`<li style="margin-bottom:8px">${r}</li>`).join("")+"</ol>",s("#rulesModal").style.display="flex"};s("#dataBtn").onclick=()=>{O(!1),s("#dataModal").style.display="flex",R(),typeof B=="function"&&B(g&&g.getStatus?g.getStatus():{code:"unsupported"})};s("#closeData").onclick=()=>{s("#dataModal").style.display="none"};async function G(){o.round=1,o.players.A={name:"Player A",score:0,streak:0,avatar:""},o.players.B={name:"Player B",score:0,streak:0,avatar:""},o.history=[],o.roundWinners=[],b();try{localStorage.removeItem("punchBuggy"),localStorage.removeItem("punchBuggy_last_backup"),localStorage.removeItem("punchbuggy-auto-backup-enabled"),localStorage.removeItem("punchbuggy-auto-backup-meta");const t=[];for(let r=0;r<localStorage.length;r++){const n=localStorage.key(r);n&&n.startsWith("punchBuggy_backup_")&&t.push(n)}t.forEach(r=>localStorage.removeItem(r))}catch(t){console.warn("Failed to clear localStorage",t)}if(window.indexedDB&&g&&g.DB_NAME)try{await new Promise((t,r)=>{const n=indexedDB.deleteDatabase(g.DB_NAME);n.onsuccess=()=>t(),n.onerror=()=>r(n.error),n.onblocked=()=>t()})}catch(t){console.warn("Failed to clear IndexedDB backups",t)}typeof B=="function"&&g&&g.getStatus&&B(g.getStatus())}s("#clearData").onclick=()=>{confirm("Clear all game data (rounds, scores, history, names, avatars)?")&&G()};s("#exportData").onclick=()=>{const t=JSON.stringify(o,null,2),r=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(r),c=document.createElement("a");c.href=n,c.download=`punchbuggy-export-${Date.now()}.json`,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(n)};function z(t){if(!t||typeof t!="object")return{error:"invalid"};const r=t.data&&typeof t.data=="object"?t.data:t,n={};n.players={A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},r.players&&typeof r.players=="object"&&["A","B"].forEach(e=>{const a=r.players[e]||{},i=typeof a.name=="string"&&a.name.trim()?a.name.trim():n.players[e].name,p=typeof a.avatar=="string"?a.avatar:"";let f=0,l=0;a.current&&typeof a.current=="object"?(f=Number(a.current.score)||0,l=Number(a.current.streak)||0):(f=Number(a.score)||0,l=Number(a.streak)||0),n.players[e]={name:i,score:f,streak:l,avatar:p}}),Number.isFinite(Number(r.round))?n.round=Math.max(1,Math.round(Number(r.round))):r.rounds&&r.rounds.current&&Number.isFinite(Number(r.rounds.current.number))?n.round=Math.max(1,Math.round(Number(r.rounds.current.number))):n.round=1,n.roundWinners=[],r.rounds&&Array.isArray(r.rounds.history)?n.roundWinners=r.rounds.history.map(e=>{const a=e&&e.winner?e.winner:"T",i=e&&e.scores&&Number.isFinite(Number(e.scores.A))?Number(e.scores.A):0,p=e&&e.scores&&Number.isFinite(Number(e.scores.B))?Number(e.scores.B):0;return{winner:a,scoreA:i,scoreB:p}}):Array.isArray(r.roundWinners)&&(n.roundWinners=r.roundWinners.map(e=>typeof e=="string"?e==="A"?{winner:"A",scoreA:0,scoreB:0}:e==="B"?{winner:"B",scoreA:0,scoreB:0}:{winner:"T",scoreA:0,scoreB:0}:e).filter(Boolean)),Array.isArray(r.history)?n.history=r.history.map(e=>{if(typeof e=="string")return e;if(e&&e.message)return e.message;try{return JSON.stringify(e)}catch{return String(e)}}):n.history=[];const c=r.schemaVersion||t.schemaVersion;return c&&(n.schemaVersion=c),n}s("#importBtn").onclick=()=>s("#importFile").click();s("#importFile").onchange=async t=>{const r=t.target.files&&t.target.files[0];if(r){try{const n=await r.text(),c=JSON.parse(n),e=z(c);if(e&&e.error){alert("Invalid file: could not parse import"),t.target.value="";return}if(!confirm("Importing will replace your current game state. Continue?")){t.target.value="";return}Object.assign(o,e),b(),alert("Import successful")}catch(n){alert("Failed to import: "+(n&&n.message?n.message:String(n)))}t.target.value=""}};const C=s("#backupStatusText"),U=s("#backupMetaText"),w=s("#autoBackupToggle"),_=s("#downloadBackupBtn"),k=s("#restoreBackupBtn");function v(t){if(!t)return null;const r=new Date(t);if(Number.isNaN(r.getTime()))return null;const n=Date.now()-r.getTime();if(n<30*1e3)return"just now";if(n<60*60*1e3){const c=Math.round(n/6e4);return`${c} minute${c===1?"":"s"} ago`}if(n<24*60*60*1e3){const c=Math.round(n/36e5);return`${c} hour${c===1?"":"s"} ago`}return r.toLocaleString()}function B(t){if(!C)return;const r=t||{},n=r.metadata||{};if(typeof r.enabled=="boolean"&&w&&(w.checked=r.enabled),C.textContent=r.message||(r.enabled===!1?"Automatic backups are disabled.":"Automatic backups ready."),U){const e=[];if(r.code==="unsupported")e.push("This browser does not support IndexedDB-based backups.");else{if(n.currentBackupDate){const a=v(n.currentBackupDate);a&&e.push(`Current backup saved ${a}`)}if(n.previousBackupDate){const a=v(n.previousBackupDate);a&&e.push(`Previous backup saved ${a}`)}if(n.oldestBackupDate){const a=v(n.oldestBackupDate);a&&e.push(`Oldest backup saved ${a}`)}if(!n.currentBackupDate&&r.enabled!==!1&&e.push("No backups have been created yet."),r.code==="error"&&r.error){const a=r.error&&r.error.message?r.error.message:String(r.error);e.push(`Error: ${a}`)}}U.textContent=e.join(" ‚Ä¢ ")}const c=r.code==="unsupported"||r.enabled===!1;_&&(_.disabled=c),k&&(k.disabled=c||!(n.backupCount>0))}function J(t){if(!t||typeof t!="object")return;const r={round:1,players:{A:{name:"Player A",score:0,streak:0,avatar:""},B:{name:"Player B",score:0,streak:0,avatar:""}},roundWinners:[],history:[]},n=Object.assign({},r,t),c=t&&t.players?t.players:{};n.players=Object.assign({},r.players,c),n.players.A=Object.assign({},r.players.A,c.A||{}),n.players.B=Object.assign({},r.players.B,c.B||{}),n.roundWinners=Array.isArray(t&&t.roundWinners)?t.roundWinners.slice():[],n.history=Array.isArray(t&&t.history)?t.history.slice():[],Object.assign(o,n),b()}!g||!g.SUPPORTED?(B({code:"unsupported",message:"Automatic backups are unavailable in this browser.",enabled:!1}),w&&(w.disabled=!0),_&&(_.disabled=!0),k&&(k.disabled=!0)):(w&&w.addEventListener("change",t=>{try{g.setEnabled(t.target.checked)}catch(r){console.error("AutoBackup toggle failed",r),t.target.checked=!t.target.checked}}),_&&(_.onclick=async()=>{try{await g.manualBackup()}catch(t){console.error("Manual backup failed",t),alert("Failed to download backup: "+(t&&t.message?t.message:t))}}),k&&(k.onclick=async()=>{try{const t=await g.listBackups();if(!t.length){alert("No backups available to restore yet.");return}const r={current:"Current",previous:"Previous",oldest:"Oldest"},n=t.map((p,f)=>{const l=v(p.savedAt)||p.savedAt||"unknown time";return`${f+1}. ${r[p.key]||p.key} ‚Äî saved ${l}`}),c=prompt(`Restore which backup?
${n.join(`
`)}
Enter a number:`,"1");if(!c)return;const e=parseInt(c,10)-1;if(Number.isNaN(e)||e<0||e>=t.length){alert("Invalid selection.");return}const a=t[e],i=v(a.savedAt)||a.savedAt||"an unknown time";if(!confirm(`Restore the ${r[a.key]||a.key} backup from ${i}? This will replace your current game data.`))return;await g.restoreFromBackup(a.key),alert("Backup restored successfully.")}catch(t){console.error("Restore backup failed",t),alert("Failed to restore backup: "+(t&&t.message?t.message:t))}}),g.init({getState:()=>o,applyState:J,onStatusChange:B}),B(g.getStatus()));s("#closeRules").onclick=()=>{s("#rulesModal").style.display="none"};s("#nameA").onchange=t=>{o.players.A.name=t.target.value,b()};s("#nameB").onchange=t=>{o.players.B.name=t.target.value,b()};s("#uploadA").onchange=t=>M("A",t.target.files[0]);s("#uploadB").onchange=t=>M("B",t.target.files[0]);function X(){if(!("serviceWorker"in navigator))return;window.PUNCHBUGGY_AUTO_APPLY_UPDATES=window.PUNCHBUGGY_AUTO_APPLY_UPDATES===void 0?!1:!!window.PUNCHBUGGY_AUTO_APPLY_UPDATES;const t=s("#updateBanner"),r=s("#updateBannerText"),n=s("#refreshUpdate"),c=s("#dismissUpdate"),e=document.documentElement;let a=null,i=null,p=!1;function f(){if(!t||t.style.display==="none")return;const d=()=>{const h=t.getBoundingClientRect().height||0;e&&e.style.setProperty("--update-banner-offset",`${Math.ceil(h+16)}px`)};window.requestAnimationFrame?requestAnimationFrame(()=>requestAnimationFrame(d)):setTimeout(d,0)}function l(){i&&clearTimeout(i),i=null,t&&(t.style.display="none"),a=null,e&&e.style.setProperty("--update-banner-offset","0px")}function y(){if(a){const d=a;p=!0,localStorage.setItem("punchBuggy_running_version",window.PUNCHBUGGY_APP_VERSION||"unknown"),console.log("[PunchBuggy] Update requested, new version will be:",window.PUNCHBUGGY_APP_VERSION),l(),d.postMessage({type:"SKIP_WAITING"})}}function u(d){if(a=d,!!t){if(r){const h=window.PUNCHBUGGY_APP_VERSION||"latest";r.textContent=`Version ${h} is ready. Refresh to load the latest updates.`}t.style.display="flex",f(),i&&clearTimeout(i),window.PUNCHBUGGY_AUTO_APPLY_UPDATES?i=setTimeout(()=>{a&&y()},3e4):i=null}}n&&(n.onclick=()=>y()),c&&(c.onclick=()=>l()),window.addEventListener("resize",f),window.DEBUG_showUpdateBanner=function(d){try{if(!t)return;r&&(r.textContent=d||`Version ${window.PUNCHBUGGY_APP_VERSION||"latest"} is ready. Refresh to load the latest updates.`),t.style.display="flex",f()}catch(h){console.warn("DEBUG_showUpdateBanner failed",h)}},navigator.serviceWorker.addEventListener("controllerchange",()=>{p&&window.location.reload()}),navigator.serviceWorker.register("/service-worker.js").then(d=>{d.waiting&&u(d.waiting),d.addEventListener("updatefound",()=>{const h=d.installing;h&&h.addEventListener("statechange",()=>{h.state==="installed"&&navigator.serviceWorker.controller&&u(h)})}),setInterval(()=>{document.visibilityState==="visible"&&d.update()},5*60*1e3)}).catch(d=>{console.error("Service worker registration failed:",d)})}try{if(window.PunchBuggyMigrations&&typeof window.PunchBuggyMigrations.migrateIfNeeded=="function"){const t=window.PunchBuggyMigrations.migrateIfNeeded();if(t&&t.migrated){const r=document.getElementById("modalLog");r&&r.insertAdjacentHTML("beforeend",`<li>Migrated local data to schema v2.0.0 ‚Äî backup key: ${t.backupKey||"unknown"}</li>`);const n=document.getElementById("backupMetaText");n&&t.backupKey&&(n.textContent=`A backup was created: ${t.backupKey}`)}}}catch(t){console.error("Migration call failed",t)}L();X();
